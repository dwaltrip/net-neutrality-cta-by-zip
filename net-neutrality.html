<link href="//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.min.css" rel="stylesheet">
<style>

body { 
  background: #15151c;
  color: #ccc;
}

p { 
  font-size: 16px;
}

hr {
  border: 0;
  height: 1px;
  background: #292929;
}

.highlight { fill: #2dbb9b; }
.district { fill: none; }

.states { 
  stroke: #7573bc;
  stroke-width: 0.2px;
  fill: none;
}

.form-container {
  padding: 20px;
}

.form-card {
  width: 100%;
  max-width: 500px;
  border-radius: 5px;
  margin: 10px;
  height: 400px;
  margin: 0 auto;
  text-align: center;
}

h1 {
  margin: 0;
  padding-top: 20px;
}

.form-head {
  width: 100%;
  height: 120px;
  background-color: #7573bc;
  color: #fff;
  border-top-left-radius: 5px;
  border-top-right-radius: 5px;
}

.form-div {
  width: 100%;
  background-color: #fff;
  height: 160px;
}

.zip-box {
  position: absolute;
  width: 100%;
  top: 100px;
  left: 0;
}

.form-foot {
  width: 100%;
  background-color: #d0ede7;
  height: 120px;
  border-bottom-left-radius: 5px;
  border-bottom-right-radius: 5px;
}

.form-box {
  width: 80%;
  margin-top: 30px;
  margin-bottom: 5px;
  line-height: 100px;
  font-size: 30px;;
  border: 0px;
  padding: 0px;
  text-align: center;
  color: #666;
}

.form-box.secondary {
  width: 300px;
  line-height: 24px;
  font-size: 14px;
}

.form-submit.secondary {
  width: 100px;
  line-height: 24px;
  font-size: 14px;
}

.form-submit {
  width: 80%;
  line-height: 80px;
  font-size: 24px;
  font-weight: bold;
  border: 0px;
  padding: 0px;
  margin: 20px;
  text-align: center;
  color: #fff;
  border-radius: 5px;
  background: #2dbb9b;
  box-shadow: 0 2px 1px rgba(36,95,82,0.7);
}

.form-box:focus {
  outline: 0px; 
}

.zip-alert {
  margin-top: 5px;
}

.graphic-container {
  text-align: center;
  display: block;
}

.graphic-div {
  width: 380px;
  height: 400px;
  position: relative;
  display: inline-block;
  margin: 2px;
}

.social-container {
  width: 100%;
  text-align: center;
}

.hide {
  display: none;
}

.state-counter-sentence, .district-counter-sentence, .callout {
  font-size: 18px;
}

#district-title {
  font-size: 30px;
}

.axis path,
.axis line {
  fill: none;
  stroke: #7573bc;
  shape-rendering: crispEdges;
}

.axis path,
.y.axis line {
  display: none;
}

.y.axis, .x.axis text {
  fill: #7573bc;
  font-size: 12px;
}

.axis-label {
  font-size: 11px;
  fill: #343444;
}

.bar-label {
  font-size: 11px;
}

.graph-title {
  fill: #7573bc;
  font-size: 12px;
}

.social-callout {
  font-size: 20px;
  color: #2dbb9b;
  padding: 0px 80px 0px 80px;
}

.img-div {
  position: relative;
  vertical-align: middle;
  display: block;
}

.rep-img-container, .rep-color {
  width: 160px;
  height: 200px;
}

.rep-img-container {
  display: inline-block;
}

.rep-img {
  height: 100%; 
  width: 100%; 
}

.rep-color {
  position: absolute;
  top: 0;
  width: 160px;
  height: 200px;
}

.undecided .rep-color {
  background-color: rgba(46,46,80,0.5);
}

.team-cable .rep-color {
  background-color: rgba(231,75,76,0.5);
}

.team-internet .rep-color {
  background-color: rgba(44,188,155,0.5);
}

.rep-name {
  position: absolute;
  left 0;
  font-weight: bold;
  font-size: 15px;
  width: 160px;
  line-height: 15px;
  bottom: 10px;
  color: #ccc;
  text-shadow: 1px 1px 1px rgba(0,0,0,0.7);
  z-index: 10;
}

.social-div {
  color: white;
  cursor: pointer;
  font-weight: bold;
  text-align: center;
  -webkit-transition: opacity 0.3s;
  transition: opacity 0.3s;
  display: inline-block;
  vertical-align: top;
  margin-top: 25px;
}

.social-div a {
  color: #ccc;
  text-decoration: none;
  font-size: 20px;
  display: block;
  height: 50px;
  line-height: 50px;
  text-align: right;
  padding-left: 10px;
  padding-right: 10px;
}

.social-div a .icon-fixed-width {
  text-align: center;
  padding-right: 0;
}

.img-social {
  margin: 0px;
  width: 80px;
  height: 100px;
  font-size: 30px;
  color: white;
}

.img-social a {
  color: white;
  text-decoration: none;
}

.social-div a:hover {
  color: #2dbb9b;
  text-decoration: none;
}

.chamber {
  font-size: 10px;
}

.social-label {
  font-size: 15px;
  padding-right: 5px;
}

.rep-section-header {
  font-size: 20px;
  font-weight: bold;
  color: #ccc;
  padding: 10px;
  text-align: center;
}

.header-subtext {
  font-weight: normal; 
  font-size: 18px;
}

.call-script {
  width: 350px;
  text-align: center;
}

#modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: #000;
  opacity: 0.5;
  filter: alpha(opacity=50);
  z-index: 100;
}

#modal {
  position: absolute;
  background-color: #7573bc;
  border-radius: 10px;
  box-shadow: 0px 0px 0px 0.1em #5C5C5C;
  padding: 8px;
  z-index: 101;
}

#modal-content {
  border-radius: 8px;
  background-color: #15151c;
  padding: 20px;
  color: #ccc;
}

#modal-close {
  position: absolute;
  width: 24px;
  height: 24px;
  display: block;
  top: -7px;
  right: -7px;
  display: block;
  background-color: #15151c;
  border-radius: 50%;
  border: 3px solid #ccc;
  color: #ccc;
  text-align: center;
  line-height: 27px;
  text-decoration: none;
}

</style>

<div class="form-container">
  <div class="form-card">
    <div class="form-head">
      <h1>Take Action Now!</h1>
      <p>Enter in your zipcode to find out how</p>
    </div>
    <form id="zip" >
      <div class="form-div">
        <input id="box1" class="form-box" type="text" name="zip-form" placeholder="Enter zip code">
        <p class="zip-alert"></p>
      </div>
      
      <div class="form-foot">
        <input class="form-submit" type="submit" value="SUBMIT">
      </div>
    </form>
  </div>
</div>
<div class="graphic-container hide">
  <div class="graphic-div" id="map"></div>
  <div class="graphic-div" id="stats">
    <p id="district-title">You're in <span id="district-name"></span></p>
    <hr>
    <p>
      <p class="district-counter-sentence hide">
        Your district submitted <span id="district-count"></span> comments
      </p>
      <p class="callout hide" id="district-callout">
        <span id="district-callout-sentence"></span>
      </p>
      <div class="hide" id="district-callout-graph"></div>
    </p>
    <hr>
    <p>
      <p class="state-counter-sentence hide">
        Your state submitted <span id="state-count"></span> comments
      </p>
      <p class="callout hide" id="state-callout">
        <span id="state-callout-sentence"></span>
      </p>
      <div class="hide" id="state-callout-graph"></div>
    </p>
  </div>
  <div class="social-container">
    <p class="social-callout"><strong>ISN'T IT TIME FOR YOUR REPRESENTATIVES TO TAKE A STAND?</strong></p>
    <div class="img-container"></div>
    <div>
      <form id="zip2">
        <input id="box2" class="form-box secondary" type="text" name="zip-form" placeholder="Enter another zip code">
        <input class="form-submit secondary" type="submit" value="SUBMIT">
      </form>
      <p style="color: #666;" class="zip-alert"></p>
    </div>
  </div>
</div>

<script src="//cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.4/queue.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/topojson/1.1.0/topojson.min.js"></script>
<script src="//cdn.rawgit.com/mbostock/d3/master/lib/colorbrewer/colorbrewer.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3-tip/0.6.3/d3-tip.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/chosen/1.1.0/chosen.jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>



<script>

// Load data, set comma formatting, define Tweet URL
var data = dataset.content;
var cma = d3.format(",");
var zero = d3.format("05d");
var LINK_URL = "http://www.batteforthenet.com";

// Finds which callouts to write and makes graphs
function write(row,rankings,aggData) {
  
  var districtNumber = row.district,
      stateName = row.name,
      stateCode = row.state, 
      stateComments = _.where(aggData,{state:stateCode})[0].comments;  

  // Add district and state names, district and state comment counts
  d3.select("#state-name").text(stateName);
  d3.select("#district-count").text(cma(d3.round(row.comments)));
  d3.select("#state-count").text(cma(d3.round(stateComments)));
  
  // Get feature to call out
  var districtFeature = getDistrictFeature(rankings);
  var stateFeature = getStateFeature(rankings);
  
  // Write district text
  if (districtFeature == 1) {
    d3.select("#district-callout-sentence")
        .text("Your district is " + sfx(rankings.districtNationalRank) +
        " in the entire country in total comments!");
  } else if (districtFeature == 2) {
    d3.select("#district-callout-sentence")
        .text("Your district is in the top 10% of the country in total comments!");
  } else if (districtFeature == 3) {
    d3.select("#district-callout-sentence")
        .text("Your district is " + sfx(rankings.districtStateRank) + 
        " in the state in total comments!");
  }
  
  // Make district chart
  if (districtFeature < 4) {
    $("#district-callout").removeClass("hide");
    $(".district-counter-sentence").addClass("hide");
    drawDistrictBar(row,"comments");
  } else {
    $(".district-counter-sentence").removeClass("hide");
  }

  
  // Write state text
  if (stateFeature == 1) {
    d3.select("#state-callout-sentence")
        .text("In the country, your state is " + sfx(rankings.stateTotalRank) + 
        " in total comments and " + sfx(rankings.statePCRank) + " in comments per 100,000 people!");
  } else if (stateFeature == 2) {
    d3.select("#state-callout-sentence")
        .text("In the country, your state is " + sfx(rankings.stateTotalRank) + 
        " in total comments!")
  } else if (stateFeature == 3) {
    d3.select("#state-callout-sentence")
        .text("In the country, your state is " + sfx(rankings.statePCRank) + 
        " in comments per 100,000 people!")
  }
  
  // Make state chart
  if (stateFeature < 3) {
    $("#state-callout").removeClass("hide");
    $(".state-counter-sentence").addClass("hide");
    drawStateBar(row.state,aggData,"comments");
  } else if (stateFeature == 3) {
    $("#state-callout").removeClass("hide");  
    $(".state-counter-sentence").addClass("hide");
    drawStateBar(row.state,aggData,"commentsPC");
  } else {
    $(".state-counter-sentence").removeClass("hide");
  }
  
}

// Gets district-level feature to highlight 
function getDistrictFeature(rankings) {
  if (rankings.districtNationalRank <= 20) {
    return 1;
  } else if (rankings.districtNationalRank <= 43) {
    return 2;
  } else if (rankings.districtStateRank <= 10 && 
    rankings.districtStateRank < rankings.inStateDistricts/2) {
    return 3  
  } else {
    return 4
  }
}

// Gets sentence type to highlight for state
function getStateFeature(rankings) {
  if (rankings.stateTotalRank <= 10) {
    if (rankings.statePCRank <= 10) {
      return 1
    } else {
      return 2
    }
  } else if (rankings.statePCRank <= 10) { 
    return 3
  } else { 
    return 4
  }
}

// Finds total and per capita state tallies
function stateTallys() {
  var states = _.uniq(_.pluck(data,"state")),
      arr = [];
  
  states.forEach(function(s) {
    var stateData = _.where(data,{state:s}),
        population = d3.sum(_.pluck(stateData,"population18")),
        comments = d3.sum(_.pluck(stateData,"comments"));
    
    arr.push({ state:s,comments:comments,commentsPC:(100000*comments/population) })
  })
  
  return arr;
}

// Draw district bar graph
function drawDistrictBar(row,type) {
  
  var value = row[type],
      district = "District " + row.district;
  
  var arr = _.pluck(data,type),
      median = d3.median(arr);
  
  var barData = [
        {bar: "YOUR DISTRICT", value: value},
        {bar: "Median District", value: median}
      ];
  
  drawBar(barData,"district","comments");
}

// Draw state bar graph
function drawStateBar(state,agg,type) {
  
  var stateName = _.where(data,{state:state})[0].name,
      value = _.where(agg,{state:state})[0][type];
  
  var arr = _.pluck(agg,type),
      median = d3.median(arr);
      
  var barData = [
        {bar: "YOUR STATE", value: value},
        {bar: "Median State", value: median}
      ];
  
  drawBar(barData,"state",type)

}

// Draw generic bar graph
function drawBar(data,type,metric) {
  
  var id = "#" + type + "-callout-graph";
  
  if (type == "district") {
    chartTitle = "Number of comments by district"
  } else if (type == "state" && metric == "comments") {
    chartTitle = "Number of comments by state"
  } else if (type == "state" && metric == "commentsPC") {
    chartTitle = "Number of comments per 100K people"
  }
  
  $(id).removeClass("hide");
  
  var margin = {top: 30, right: 20, bottom: 20, left: 100},
      width = 380 - margin.left - margin.right,
      height = 100 - margin.top - margin.bottom;

  var x = d3.scale.linear()
      .domain([0,Math.max(data[0].value,data[1].value)])
      .range([0,width]);

  var y = d3.scale.ordinal()
      .domain([data[0].bar,data[1].bar])
      .rangeBands([0, height],.4)
      
  var xAxis = d3.svg.axis()
      .scale(x)
      .ticks(2)
      .tickSize(height)
      .orient("bottom");

  var yAxis = d3.svg.axis()
      .scale(y)
      .orient("left");

  var svg = d3.select(id).append("svg")
      .attr("class","to-remove")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  svg.append("g")
      .attr("class", "x axis")
      .call(xAxis);

  svg.append("g")
      .attr("class", "y axis")
      .call(yAxis)
  
  svg.selectAll("rect")
      .data(data)
    .enter().append("rect")
      .attr("x",0)
      .attr("y",function(d) { return y(d.bar); })
      .attr("width",function(d) { return x(d.value); })
      .attr("height",y.rangeBand())
      .attr("fill","#2dbb9b")
  
  svg.selectAll(".bar-label")
      .data(data)
    .enter().append("text")
      .attr("class","bar-label")
      .attr("x",function(d) { 
          var val = x(d.value)
          if (val < 30) { return val + 3; } else { return val - 3; }
      })
      .attr("y",function(d) { return y(d.bar) + y.rangeBand()/2; })
      .attr("dy",".37em")
      .attr("text-anchor",function(d) { 
          var val = x(d.value)
          if (val >= 30) { return "end"; }
      })
      .attr("fill",function(d) { 
          var val = x(d.value)
          if (val < 30) { return "#7573bc"; } else { return "black"; }
      })
      .text(function(d) { return cma(d3.round(d.value)); })
  
  svg.append("text")
      .attr("class","graph-title")
      .attr("x",width/2 - margin.left/2)
      .attr("y",-20)
      .attr("text-anchor","middle")
      .text(chartTitle)
}

// Gets district and state rankings, by total and per capita comments
function getRankings(districtRow,agg) {
  
  var stateCode = districtRow.state;
  
  // Get district counts for distict rankings
  var districtComments = districtRow.comments,
      districtsWithMore = _.filter(data,function(d){ return d.comments > districtComments; }),
      inStateDistrictsWithMore = _.where(districtsWithMore, {state: stateCode }),
      inStateDistricts = _.where(data, {state: stateCode });
  
  var districtNationalRank = districtsWithMore.length + 1,
      districtStateRank = inStateDistrictsWithMore.length + 1;
  
  // Get state ranks
  var stateComments = _.where(agg, {state: stateCode })[0].comments,
      stateCommentsPerCapita = _.where(agg, {state: stateCode })[0].commentsPC,
      statesWithMoreTotal = _.filter(agg, function(d) { return d.comments > stateComments; }),
      statesWithMorePC = _.filter(agg, function(d) { return d.commentsPC > stateCommentsPerCapita; });

  var stateTotalRank = statesWithMoreTotal.length + 1,
      statePCRank = statesWithMorePC.length + 1;
  
  // Make rank object
  var rankings = {
    districtNationalRank: districtNationalRank,
    districtStateRank: districtStateRank,
    inStateDistricts: inStateDistricts.length,
    stateTotalRank: stateTotalRank,
    statePCRank: statePCRank
  }
  
  return rankings;
}

// Returns district row
function selectDistrict(state,district) {
  return _.where(data,{letter_code:state,district:district})[0];
}

// Write main district name
function nameDistrict(districtRow) {
  var districtNumber = districtRow.district,
      stateName = districtRow.name;
      
  d3.select("#district-name").text(stateName + "'s " + sfx(districtNumber) + " District");
}


// Draws district map. Draws state outline, shades district
function drawMap(districtRow) {
  
  var district = districtRow.district_code,
      state = districtRow.state;
  
  queue()
    .defer(d3.json, "https://cdn.rawgit.com/dwaltrip/net-neutrality-cta-by-zip/master/assets/us.json")
    .defer(d3.json, "https://cdn.rawgit.com/dwaltrip/net-neutrality-cta-by-zip/master/assets/us-congress-113.json")
    .await(ready);
    
  function ready(error,us,congress) {
    
    var mapWidth = 380,
        mapHeight = 400;
  
    var projection = d3.geo.albersUsa()
        .scale(mapWidth*1.3)
        .translate([mapWidth/2, mapHeight/2]);
      
    var path = d3.geo.path()
        .projection(projection);
    
    var districtTopo = topojson.feature(congress, congress.objects.districts).features,
        districtPath = _.filter(districtTopo,function(d) { return Math.floor(d.id/100) == state; }),
        
        statePath = _.where(topojson.feature(us, us.objects.states).features,{id:state}),
        
        bounds = path.bounds(statePath[0].geometry),
        maxSize = Math.max((bounds[1][0] - bounds[0][0]),(bounds[1][1] - bounds[0][1])),
        
        centered = path.centroid(statePath[0].geometry),
        
        x = centered[0],
        y = centered[1],
        k = Math.min(300/maxSize,30);
        
        
    var svg = d3.select("#map").append("svg")
        .attr("class","to-remove")
        .attr("width", mapWidth)
        .attr("height", mapHeight);
    
    g = svg.append("g")
        .attr("transform", "translate(" + mapWidth / 2 + "," + mapHeight / 2 + ")scale(" 
        + k + ")translate(" + -x + "," + -y + ")")
      
    g.append("defs").append("path")
        .attr("id", "land")
        .datum(topojson.feature(us, us.objects.land))
        .attr("d", path);
      
    g.append("clipPath")
        .attr("id", "clip-land")
      .append("use")
        .attr("xlink:href", "#land");
  
    g.append("g")
        .attr("class", "districts")
        .attr("clip-path", "url(#clip-land)")
      .selectAll("path")
        .data(districtPath)
      .enter().append("path")
        .attr("class",function(d) { 
          if (d.id == district) { 
            return "highlight"; 
          } else {
            return "district";
          }
        })
        .attr("d", path);
    
    g.append("g")
      .selectAll("path")
        .data(statePath)
      .enter().append("path")
        .attr("class","states")
        .attr("d", path);
  }
}



function socialCallouts(zip,row,agg) {

  var renderRepCallout = Handlebars.compile("\
    {{#if showHeader}}\
      <div class='rep-section-header to-remove'>\
        {{#if repIsUndecided}}\
          Undecided\
          <div class='header-subtext'>Contact your representantive and help them make the right choice!</div>\
        {{/if}}\
        \
        {{#if repIsOnTeamCable}}\
          Team Cable\
          <div class='header-subtext'>Tell your rep why you disagree with their position.</div>\
        {{/if}}\
        \
        {{#if repIsOnTeamInternet}}\
          Team  Internet\
          <div class='header-subtext'>Give them an encouraging thumbs up!</div>\
        {{/if}}\
      </div>\
    {{/if}}\
    \
    <div class='img-div to-remove {{stance}}'>\
      <div class='rep-img-container'>\
        <img class='rep-img' src='{{imgUrl}}'>\
        <div class='rep-name'>\
          {{lastName}}<br>\
          <span class='chamber'>{{chamber}}</span>\
        </div>\
        <div class='rep-color'></div>\
      </div>\
      \
      <div class='social-div'>\
        <a href='{{twitterUrl}}' target='_blank'>\
          <span class='social-label'>Tweet:</span><icon class='icon-fixed-width icon-twitter'></icon>\
        </a>\
        <a data-lookup-key='{{lookupKey}}' href='#' class='call-link'>\
          <span class='social-label'>Call:</span><icon class='icon-fixed-width icon-phone'></icon>\
        </a>\
        <a href='{{contactFormUrl}}' target='_blank'>\
          <span class='social-label'>E-mail:</span><icon class='icon-fixed-width icon-envelope'></icon>\
        </a>\
      </div>\
    </div>\
  ");
  
  url = "//congress.api.sunlightfoundation.com/legislators/locate?zip=" + zip + 
    "&apikey=29f0edf2b7384260863a8b51bcbed266";
  
  var result = httpGet(url),
      json = JSON.parse(result);
  
  var state = row.letter_code,
      district = row.district,
      stateComments = _.where(agg,{state:row.state})[0].comments
  
  var reps = getReps(json,state,district);

  var undecidedCount = 0;
  
  var repsWithData = reps.map(function(rep, index) {

    if (rep.chamber == 'house') {
      var stance = row.rep_alignment,
          imgUrl = row.rep_image,
          constituentComments = row.comments; 
          
    } else if (rep.chamber == 'senate' && rep.state_rank == 'senior') { 
      var stance = row.sen1_alignment,
          imgUrl = row.sen1_image,
          constituentComments = stateComments;
          
    } else if (rep.chamber == 'senate' && rep.state_rank == 'junior') { 
      var stance = row.sen2_alignment,
          imgUrl = row.sen2_image,
          constituentComments = stateComments;
    }

    var twitterUrl = "https://twitter.com/intent/tweet?text=.%40" + rep.twitter_id + 
      " Please tell the %40FCC you want them to protect %23NetNeutrality. " + 
      cma(constituentComments) + " of your constituents already did! " + LINK_URL
  
    if (stance === 'undecided') { undecidedCount += 1; }

    var repData = {
      lastName: rep.last_name,
      fullName: rep.first_name + ' ' + rep.last_name,
      imgUrl: imgUrl,
      facebookUrl: "https://facebook.com/" + rep.facebook_id,
      phoneNumber: rep.phone,
      twitterUrl: twitterUrl,
      contactFormUrl: rep.contact_form,
      chamber: rep.chamber.toUpperCase(),
      stance: stance,
      repIsUndecided: (stance === 'undecided'),
      repIsOnTeamInternet: (stance === 'team-internet'),
      repIsOnTeamCable: (stance === 'team-cable'),
      lookupKey: 'rep' + index
    };

    return repData;
  });

  // sort by stance: no stance first, team cable second, and team internet last
  var sortByStance = function(rep1, rep2) {
    var sortVal = function(repData) {
      switch(repData.stance) {
        case 'undecided':
          return 0;
        case 'team-cable':
          return 1;
        case 'team-internet':
          return 2;
        default:
          return 3;
      }
    };

    return sortVal(rep1) - sortVal(rep2);
  };

  var repDataCache = {};
  var seenStanceAlready = {};
  repsWithData.sort(sortByStance).forEach(function(repData) {
    if (!seenStanceAlready[repData.stance]) {
      repData.showHeader = true;
      seenStanceAlready[repData.stance] = true;
    }

    $('.img-container').append(renderRepCallout(repData));
    repDataCache[repData.lookupKey] = repData;
  });

  var renderCallScript = Handlebars.compile("\
    <div class='call-script'>\
      <div class='script-header'>{{fullName}}</div>\
      <div class='phone-number'>{{phoneNumber}}</div>\
      {{scriptText}}\
    </div>\
  ");

  var modal = new Modal();
  var placeholderText = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris id erat sit amet dui lobortis vehicula. Duis dictum nisi quis lorem sagittis, et tempus turpis tempor. Phasellus urna sapien, ultrices dignissim tristique pellentesque, efficitur vel velit. Aliquam semper eleifend facilisis. Phasellus lorem magna, venenatis et quam eget, placerat dapibus massa. Nulla vitae ipsum quis sem iaculis malesuada. Sed placerat scelerisque nisl, a lacinia nunc cursus iaculis. Curabitur libero massa, scelerisque in vulputate vitae, accumsan quis quam. Vestibulum ut varius justo. Donec consequat luctus justo. Suspendisse non luctus libero. Fusce varius fermentum est non pretium. Suspendisse viverra, nunc ac efficitur euismod, lacus nisl egestas metus, vitae viverra mi mauris sed elit. Quisque in dui eu ipsum porttitor dignissim. Etiam dapibus urna vel ornare ornare.";

  $('.call-link').on('click', function(e) {
    e.preventDefault();
    $link = $(this);
    var repLookupKey = $link.data('lookup-key');
    var repData = repDataCache[repLookupKey];

    modal.open({
      content: renderCallScript({
        fullName: repData.fullName,
        phoneNumber: repData.phoneNumber,
        scriptText: placeholderText
      })
    });
  });
}

// Gets reps from Sunlight API response
function getReps(json,state,dist) {
  reps = _.where(json.results,{state:state,chamber:"house",district:dist})
  sens = _.where(json.results,{state:state,chamber:"senate"})
  
  return reps.concat(sens)
}

// Gets district via Sunlight API from zip
function getDistrict(zip) {
  var url = "//congress.api.sunlightfoundation.com/districts/locate?zip=" + zip + 
    "&apikey=29f0edf2b7384260863a8b51bcbed266";

  var result = httpGet(url),
      json = JSON.parse(result);
  
  return json.results[0];
}

// Retrives URL
function httpGet(theUrl) {
  var xmlHttp = null;
  
  xmlHttp = new XMLHttpRequest();
  xmlHttp.open( "GET", theUrl, false );
  xmlHttp.send( null );
  return xmlHttp.responseText;
}

// Input for initial form
$("#zip").submit(function( event ) {

  var zip = $("#box1").val(),
      zip = +zip;
  
  checkZip(zip);
});

// Input for 2nd zip form
$("#zip2").submit(function( event ) {
  
  var zip = $("#box2").val(),
      zip = +zip;
      
  checkZip(zip)

});

// Checks if zip is valid. If yes, renders graphic.
// If not, displays bad zip error.
function checkZip(zip) {
  if (zip === parseInt(zip)) {
    if (zip >= 00000 && zip <= 99999) {
       
      zip = zero(zip);
      geo = getDistrict(zip);
       
      if (typeof geo === 'undefined') {
        badZip()
      } else {
        render(geo,zip)
      }
      
    } else {
      badZip();
    }
  } else {
    badZip();
  }
}

// Show bad Zip error
function badZip() {
  d3.selectAll(".zip-alert")
      .text("Please enter a valid zip code")
}

function sfx(int) {
  if (int % 10 == 1) { return "1st"; }
  else if (int % 10 == 2) { return "2nd"; }
  else if (int % 10 == 3) { return "3rd"; }
  else { return int + "th"; }
}

function render(geo,zip) {
  
  // Removes initial form
  $(".form-container").addClass("hide");
  //Shows graphic
  $(".graphic-container").removeClass("hide");
  
  //Removes state callouts in case of second zip
  $("#state-callout").addClass("hide");
  $("#district-callout").addClass("hide");
  
  // Removes zip alert
  d3.selectAll(".zip-alert").text("");
  
  // Removes rep images and social
  d3.selectAll(".to-remove").remove();
  
  // Find state and district info
  var stateAbbrev = geo.state,
      districtNumber = geo.district;
  
  // Fix for DC district
  if (stateAbbrev == "DC") { districtNumber = 98; }

  // Pull out row from data table 
  var districtRow = selectDistrict(stateAbbrev,districtNumber);

  // Get state aggregate data
  var aggData = stateTallys();

  // Calculate rankings
  var rankings = getRankings(districtRow,aggData)
  
  // District title
  nameDistrict(districtRow);
  
  // Write comment text and graph callouts
  write(districtRow,rankings,aggData);
  
  // Render map
  drawMap(districtRow);
  
  // Render social callouts and images
  socialCallouts(zip,districtRow,aggData);
}

var Modal = function() {
  var self = this;
  var $overlay, $modal, $content, $close;

  var init = function() {
    // Generate the HTML and add it to the document
    $overlay = $('<div id="modal-overlay"></div>');
    $modal = $('<div id="modal"></div>');
    $content = $('<div id="modal-content"></div>');
    $close = $('<a id="modal-close" href="#"><i class="icon icon-remove icon-fixed-width"></i></a>');

    $overlay.hide();
    $modal.append($content);
    $modal.append($close);
    $modal.hide();

    $(document).ready(function(){
      $('body').append($overlay, $modal);
    });

    $close.click(function(e){
      e.preventDefault();
      self.close();
    });
  };

  // Open the modal
  this.open = function (settings) {
    $content.empty().append(settings.content);

    $modal.css({
      width: settings.width || 'auto',
      height: settings.height || 'auto'
    });

    center();
    $(window).bind('resize.modal', center);

    $modal.show();
    $overlay.show();
  };

  // Close the modal
  this.close = function () {
    $modal.hide();
    $overlay.hide();
    $content.empty();
    $(window).unbind('resize.modal');
  };

  // Center the modal in the viewport
  var center = function () {
    var top, left;

    top = Math.max($(window).height() - $modal.outerHeight(), 0) / 2;
    left = Math.max($(window).width() - $modal.outerWidth(), 0) / 2;

    $modal.css({
      top:top + $(window).scrollTop(),
      left:left + $(window).scrollLeft()
    });
  };

  init();
};

</script>